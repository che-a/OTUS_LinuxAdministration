## Пользователи и группы. Авторизация и аутентификация
### Содержание
1. [Описание занятия](#description)  
2. [Домашнее задание](#homework)  
3. [Справочная информация](#info)  
4. [Выполнение](#exec)  
    - [Результаты](#result)   

## 1. Описание занятия <a name="description"></a>
### Цели
- механизмы авторизации и аутентификации;  
- права у пользовталей;  
- управление правами с помощью `sudo`, `umask`, `sgid`, `suid` и более сложными инструментами как `PAM` и `ACL`, PolicyKit.  

### Результаты  
- Участники осваивают инструменты для управлением правами пользовталей, контролем авторизации и выдачи прав.  

## 2. Домашнее задание  <a name="homework"></a>
### Постановка задачи
1. Запретить всем пользователям, кроме группы admin логин в выходные(суббота и воскресенье), без учета праздников.  
2. Дать конкретному пользователю права рута.  

## 3. Справочная информация <a name="info"></a>  

<details>
    <summary></summary>

### Основные термины и определения

PAM (Pluggable Authentication Modules)

- `Аутентификация` — процесс подтверждения пользователем своей “подлинности”. Ввод логина и пароля.  
- `Авторизация` — процесс наделения пользователя правами (предоставления доступа к каким-либо объектам).  
- `Аккаунтинг` — запись информации о произошедших событиях.  

`UID` — организационное разделение, при котором существуют две группы пользователей: одна группа — для демонов, другая — для &laquoживых&raquo пользователей; определяется в `/etc/login.defs` и используется в системных утилитах работы с пользователями и группами.  

### PAM

`PAM` — библиотека, реализующая возможность `AAA` с помощью стандартизированных динамически подгружаемых модулей; конфигурируется в `/etc/pam.d`.  

Аутентификация:  
- `pam_unix` — аутентификация в `/etc/passwd`;  
- `pam_userdb` — аутентификация против (against) BDB-файла;  
- `pam_rootok` — разрешение root’у всего.  
Авторизация:  
- `pam_wheel` — авторизация для сервиса с использованием группы `wheel`.   


###

| Флаг     | Владелец | Группа | Остальные |
|:---------|:---------|:-------|:----------|
| `-`      | `rwx`    | `rwx`  |  `rwx`    |

| oct | bin | mask |
|:----|:----|:-----|
| 0   | 000 | ---  |
| 1   | 001 | --x  |
| 2   | 010 | -w-  |
| 3   | 011 | -wx  |
| 4   | 100 | r--  |
| 5   | 101 | r-x  |
| 6   | 110 | rw-  |
| 7   | 111 | rwx  |

`SUID`, `SGID`  
- Восьмеричные значения для `SUID` и `SGID`: 4000 и 2000.  
- Символьные: `u+s` и `g+s`.  
Для исполняемого файла:  
- Файл будет исполняться с `UID`/`GID` владельца файла.  
Для директории:  
- все созданные в ней файлы будут наследовать `UID`/`GID` директории.  
`Sticky bit`  
- Восьмеричные значения для `sticky bit` - 1000.  
- Символьные: `+t`.  
Для директории:  
- Каталог с установленным `sticky`-битом означает, что удалить файл из этого каталога может только владелец файла или суперпользователь.






###
`/etc/shadow` — системный файл с паролями пользователей;  
`/etc/login.defs` — файл, в котором можно настроить в т.ч. и `UID` (мин. и макс. значения, обычно `UID` < 1000 назначаются системным пользователям);  
`/etc/shells` — доступные командные оболочки;  
`/etc/securetty` — ;  
`id user` — вывод `id` пользователя `user`;  
`/etc/group` — группы пользователей;  
`/etc/gshadow` — на группу можно поставить пароль;  
`chsh` — команда для смены оболочки;  
`groups` — показывает текущую группу;   
`newgrp` — изменить главную группу;  

#### PolicyKit
`pkaction` — список политик;  
`ldd файл` — показывает с какими библиотеками слинкован файл;  

#### ACL
`getfacl file` —

</details>

## 4. Выполнение <a name="exec"></a>  
Лабораторный стенд разворачивается из [Vagrantfile](https://github.com/che-a/OTUS_LinuxAdministrator/blob/master/tasks/10/Vagrantfile) с автоматическим провижинингом из сценария [script.sh](https://github.com/che-a/OTUS_LinuxAdministrator/blob/master/tasks/10/script.sh), запускаемого с параметром `--provision`. Далее этот же сценарий (но с другими параметрами) используется для выполнения основных задач этого домашнего задания.  
Развертывание лабораторнго стенда полностью не автоматизировано для того, чтобы была возможность сравнить состояние системы до и после проводимых в ней изменений.

### Результаты <a name="result"></a>  
#### Запрет логина в определенные дни
Запрет логина в субботу и воскресенье пользователям не входящим в группу `admin` реализована с ипользованием модуля `pam_exec`, для работы которого используется сценарий [pam_exec.sh](https://github.com/che-a/OTUS_LinuxAdministrator/blob/master/tasks/10/pam_exec.sh). На основании кода завершения этого сценария модуль `pam_exec` принимает решение: 0 — пользователь будет авторизован, 1 — нет.


В результате выполнения следующей команды создается группа `admin` с включенными в неё новыми пользователями `dux`, `fix`, `gex` и `rex`, а разрешение на вход в систему в субботу и воскресенье (локально и по `SSH`) предоставляется уже существующему пользователю `vagrant` и новому `rex`.
```bash
sudo ./script.sh --ban-weekend
```
```console
Changing password for user dux.
passwd: all authentication tokens updated successfully.
Changing password for user fix.
passwd: all authentication tokens updated successfully.
Changing password for user gex.
passwd: all authentication tokens updated successfully.
Changing password for user rex.
passwd: all authentication tokens updated successfully.
====================================================
=== Access on Saturday and Sunday is prohibited! ===
===    (except for users of the "admin"-group)   ===
====================================================
```
При попытке установить `SSH`-соединение в выходной день пользователь `gex`, который не добавлен в группу `admin`, ожидаемо терпит неудачу. При этом пользователи, добавленные в группу `admin`, наоборот, регистрируются в системе успешно.
```bash
ssh -p 2222 gex@127.0.0.1
```
```console
gex@127.0.0.1's password: 
/usr/local/bin/pam_exec.sh failed: exit code 1
Connection closed by 127.0.0.1 port 2222
```

#### Назначение прав суперпользователя обычному пользователю
Неудачная попытка обычного пользователя `rex` получить права суперпользователя показана ниже:
```bash
sudo -s
```
```console
We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

[sudo] password for rex: 
rex is not in the sudoers file.  This incident will be reported.
```

Для назначения обычному пользователю `rex` привилегий суперпользователя необходимо войти в систему под учетной записью `vagrant` и запустить сценарий:
```bash
vagrant ssh
```
```bash
sudo ./script.sh --root-privs
```
```console
====================================================
===    Superuser privileges assigned to rex    ===
====================================================
```
После этого задание можно считать выполненным:
```bash
ssh -p 2222 rex@127.0.0.1
```
```console
rex@127.0.0.1's password: 
Last login: Sat Nov 23 04:08:27 2019 from 10.0.2.2
[rex@les10 ~]$ sudo -s
[root@les10 rex]#                                                           
```
