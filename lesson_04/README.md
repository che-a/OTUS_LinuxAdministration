## Занятие 4. Bash, awk, sed, grep и другие
### Содержание
1. [Описание занятия](#description)  
2. [Домашнее задание](#homework)  
3. [Выполнение](#exec)  
    - [Демонстрация работы сценария](#demo)  
    - [Структура файла access.log](#access.log)  
 

## 1. Описание занятия <a name="description"></a>
### Цели
- уметь писать скрипты на языка `bash`

### Краткое содержание  
- Профайл;  
- Переменные;  
- Логические операции;  
- Массивы;  
- Условия;  
- Циклы;  
- Функции;  
- Регулярные выражения;  
- `sed`;  
- `awk`.  

### Результаты  
В результате этого ДЗ вы научитесь писать простые скрипты, решающие нужны задачи, такие как мониторинг кол-ва ошибок в логах.   Освоите работу с файлами, поиском, парсингом текста, управлением блокировками.

## 2. Домашнее задание  <a name="homework"></a>
### Постановка задачи  

Написать скрипт для крона, который раз в час присылает на заданную почту:
- X IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;  
- Y запрашиваемых адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;  
- все ошибки c момента последнего запуска;  
- список всех кодов возврата с указанием их кол-ва с момента последнего запуска.  

В письме должно быть прописан обрабатываемый временной диапазон, также должна быть реализована защита от мультизапуска.  

### Критерии оценки  
Трапы и функции, а также sed и find +1 балл.  

## 3. Выполнение <a name="exec"></a>  
Суть выполнненого задания заключается в развертывании из [Vagrantfile](https://github.com/che-a/OTUS_LinuxAdministrator/blob/master/lesson_04/Vagrantfile) тестового окружения с его настройкой из сценария [provision.sh](https://github.com/che-a/OTUS_LinuxAdministrator/blob/master/lesson_04/provision.sh) и запуском через планировщик заданий `cron` сценария [script.sh](https://github.com/che-a/OTUS_LinuxAdministrator/blob/master/lesson_04/script.sh) , который периодически отправляет отчет с собранной статистикой лог-файла на почтовый адрес.  

### Демонстрация работы сценария <a name="demo"></a>  
С целью отладки работы сценария [script.sh](https://github.com/che-a/OTUS_LinuxAdministrator/blob/master/lesson_04/script.sh) и демонстрации его действия в тестовом окружении создается демон, имитирующий работу веб-сервера в части формирования лог-файла путем копирования строк с изменением даты и времени из реального лог-файла [access.log](https://github.com/che-a/OTUS_LinuxAdministrator/blob/master/lesson_04/access.log) веб-сервера `nginx`.  

### Структура файла access.log  <a name="access.log"></a>  
`access.log` — это текстовый файл, использующийся веб-серверами для записи обращений к сайту. В каждой строке этого файла записывается одно обращение к серверу.  
Пример содержимого файла `access.log`:
```console
207.46.13.73 - - [21/May/2019:03:08:12 +0300] "GET /catalog/mototekhnika/pitbayki/?display=table HTTP/1.0" 200 32236 "-" "Mozilla/5.0 (compatible; bingbot/2.0; +http://www.bing.com/bingbot.htm)"
178.154.244.16 - - [21/May/2019:03:16:45 +0300] "POST /bitrix/tools/conversion/ajax_counter.php HTTP/1.0" 200 22 "https://nomoto.ru/company/news/novaya/" "Mozilla/5.0 (compatible; YandexBot/3.0; +http://yandex.com/bots)"
200.33.155.30 - - [14/Aug/2019:04:12:10 +0300] "GET / HTTP/1.1" 200 3698 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/601.7.7 (KHTML, like Gecko) Version/9.1.2 Safari/601.7.7"rt=0.000 uct="-" uht="-" urt="-"
165.22.19.102 - - [14/Aug/2019:04:38:36 +0300] "POST /wp-login.php HTTP/1.1" 200 1721 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0"rt=0.255 uct="0.000" uht="0.193" urt="0.193"
```
Более наглядное представление файла `access.log`:
```
+----------------+------------------------------+--------------------------------------------------------------+-----+-------+------------------------------------------+------------------------------------------------------------------------------------------------------------------------+
|       A        |   Время запроса к серверу    |          Тип запроса, его содержимое и версия                |  D  |   E   |          URL-источник запроса            |               HTTP-заголовок, содержащий информацию о запросе (клиентское приложение, язык и т. д.)                    |
+----------------+------------------------------+--------------------------------------------------------------+-----+-------+------------------------------------------+------------------------------------------------------------------------------------------------------------------------+
| 207.46.13.73   | [21/May/2019:03:08:12 +0300] | "GET /catalog/mototekhnika/pitbayki/?display=table HTTP/1.0" | 200 | 32236 | "-"                                      | "Mozilla/5.0 (compatible; bingbot/2.0; +http://www.bing.com/bingbot.htm)"                                              |
| 178.154.244.16 | [21/May/2019:03:16:45 +0300] | "POST /bitrix/tools/conversion/ajax_counter.php HTTP/1.0"    | 200 | 22    | "https://nomoto.ru/company/news/novaya/" | "Mozilla/5.0 (compatible; YandexBot/3.0; +http://yandex.com/bots)"                                                     |
| 200.33.155.30  | [14/Aug/2019:04:12:10 +0300] | "GET / HTTP/1.1"                                             | 200 | 3698  | "-"                                      | "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/601.7.7 (KHTML, like Gecko) Version/9.1.2 Safari/601.7.7" |
| 165.22.19.102  | [14/Aug/2019:04:38:36 +0300] | "POST /wp-login.php HTTP/1.1"                                | 200 | 1721  | "-"                                      | "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0"                                         |
+----------------+------------------------------+--------------------------------------------------------------+-----+-------+------------------------------------------+------------------------------------------------------------------------------------------------------------------------+
```
Где:  
`A` — хост/IP-адрес, с которого произведён запрос к серверу;  
`D` — код состояния HTTP;  
`E` — количество отданных сервером байт.  


